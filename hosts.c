#if 0
	shc Version 3.8.7, Generic Script Compiler
	Copyright (c) 1994-2009 Francisco Rosales <frosal@fi.upm.es>

	shc -f hosts.sh -r -v 
#endif

static  char data [] = 
#define      rlax_z	1
#define      rlax	((&data[0]))
	"\052"
#define      chk1_z	22
#define      chk1	((&data[1]))
	"\262\322\264\017\357\111\367\174\220\002\370\171\052\306\002\044"
	"\231\120\065\160\272\203"
#define      msg2_z	19
#define      msg2	((&data[23]))
	"\262\176\135\001\116\041\005\137\300\160\053\232\213\252\351\357"
	"\021\363\376\240\340\357\004"
#define      inlo_z	3
#define      inlo	((&data[46]))
	"\166\343\035"
#define      msg1_z	42
#define      msg1	((&data[52]))
	"\217\250\033\314\272\352\164\146\262\020\123\200\054\306\000\164"
	"\136\366\243\260\310\125\252\351\070\253\146\131\147\344\250\114"
	"\071\354\106\377\326\202\317\153\210\315\240\160\325\322\301\176"
	"\024\175\006\316\371\006\206"
#define      tst2_z	19
#define      tst2	((&data[104]))
	"\113\007\274\272\116\064\163\257\121\230\341\004\140\246\312\332"
	"\306\356\262"
#define      chk2_z	19
#define      chk2	((&data[124]))
	"\367\365\205\215\231\021\176\232\361\065\343\074\173\271\044\076"
	"\361\101\366\203\026\124\327"
#define      pswd_z	256
#define      pswd	((&data[168]))
	"\316\120\077\032\072\317\302\126\241\204\324\266\001\333\204\373"
	"\341\013\337\002\032\323\300\347\317\341\306\161\060\024\174\215"
	"\164\320\260\306\152\175\215\300\305\066\064\322\225\121\257\205"
	"\373\202\312\313\326\212\263\245\154\171\027\234\215\224\051\001"
	"\145\332\310\317\127\126\220\035\214\304\357\041\025\236\247\020"
	"\040\161\334\367\374\217\235\151\010\264\006\226\111\060\230\256"
	"\012\140\175\142\266\015\177\103\321\156\145\347\015\015\370\055"
	"\177\325\044\174\144\301\345\155\166\354\004\277\034\234\156\047"
	"\375\353\211\264\371\010\367\313\167\135\262\204\152\253\262\351"
	"\200\327\146\345\231\114\123\017\070\127\317\125\363\075\174\360"
	"\051\006\245\042\017\234\355\207\371\240\013\144\113\276\116\314"
	"\225\264\261\057\000\005\077\071\134\016\216\117\114\013\100\165"
	"\022\345\230\041\202\206\250\174\046\264\341\162\163\057\076\011"
	"\344\360\070\344\365\167\036\122\206\255\242\323\270\342\111\313"
	"\310\341\354\113\147\225\310\216\112\251\000\275\331\077\306\275"
	"\060\377\242\045\167\300\170\376\155\032\321\046\375\032\361\305"
	"\374\336\021\144\164\331\362\276\203\362\174\134\062\102\031\142"
	"\102\273\210\271\174\000\073\316\313\122\043\242\130\175\317\047"
	"\315"
#define      date_z	1
#define      date	((&data[435]))
	"\271"
#define      shll_z	8
#define      shll	((&data[436]))
	"\271\102\222\176\012\340\001\067\177"
#define      opts_z	3
#define      opts	((&data[445]))
	"\064\174\333"
#define      text_z	1506
#define      text	((&data[469]))
	"\205\360\305\144\363\340\070\057\257\003\202\322\246\332\120\166"
	"\002\035\205\104\046\252\231\147\027\215\070\055\244\265\231\141"
	"\041\154\066\215\040\072\304\134\072\006\136\202\002\112\062\075"
	"\371\274\100\343\161\147\300\347\345\126\076\124\126\234\053\342"
	"\270\025\361\066\143\215\120\355\200\012\020\115\122\060\053\316"
	"\041\375\136\032\277\144\062\013\273\362\171\227\273\146\303\224"
	"\221\214\163\006\274\173\077\270\144\062\347\254\247\341\351\241"
	"\030\274\203\264\321\204\125\274\077\135\012\126\202\342\222\261"
	"\047\051\162\347\212\026\350\142\337\174\042\112\033\235\066\316"
	"\156\046\060\135\263\361\252\204\176\062\334\151\116\216\371\135"
	"\130\001\070\266\342\053\372\220\345\200\122\172\072\015\252\032"
	"\114\015\064\302\254\105\035\171\157\345\064\066\332\317\313\343"
	"\142\146\203\033\154\221\056\021\157\053\274\324\361\000\157\004"
	"\345\067\355\133\133\307\026\225\166\121\062\204\366\302\377\171"
	"\106\026\020\265\231\377\052\157\276\327\033\232\003\003\233\127"
	"\141\073\155\142\266\077\346\373\352\300\222\217\060\131\174\074"
	"\167\272\312\074\013\262\131\371\037\305\174\111\301\114\072\137"
	"\016\024\345\212\314\234\011\272\015\357\363\166\164\000\155\021"
	"\020\004\101\010\156\017\206\225\231\300\355\015\320\070\073\300"
	"\123\115\066\230\333\021\230\347\372\363\312\330\027\065\075\037"
	"\124\041\124\305\013\124\113\322\371\150\317\272\143\233\376\253"
	"\264\322\272\102\150\112\130\044\245\242\121\154\031\252\242\325"
	"\037\126\177\144\336\010\106\155\264\041\067\102\022\160\322\132"
	"\001\041\076\222\073\357\210\354\150\361\007\022\046\047\050\101"
	"\013\224\145\100\257\343\245\321\030\063\350\223\032\303\106\345"
	"\142\343\301\003\201\132\254\306\110\252\345\036\006\030\107\120"
	"\353\363\354\033\157\017\213\033\171\317\051\332\317\326\034\310"
	"\232\177\110\236\205\203\331\113\343\064\317\050\243\106\301\070"
	"\254\040\043\160\127\350\332\001\003\343\312\064\160\070\222\207"
	"\261\231\126\074\012\343\115\301\164\175\117\255\345\366\233\310"
	"\231\206\054\115\176\044\361\224\064\312\333\101\252\275\010\061"
	"\312\067\124\025\051\201\110\220\213\324\165\215\232\364\234\173"
	"\215\216\230\273\240\067\113\376\364\267\114\007\272\340\236\347"
	"\344\124\135\142\015\211\026\157\111\053\207\112\024\153\267\200"
	"\335\140\006\156\344\042\142\247\254\141\143\116\323\001\104\164"
	"\220\160\101\322\113\252\221\111\004\043\213\173\253\171\257\115"
	"\340\370\261\352\242\077\357\103\012\357\160\163\046\207\261\376"
	"\375\135\350\301\003\263\333\264\331\034\167\163\253\255\322\176"
	"\255\065\165\142\374\153\212\202\301\353\354\354\360\005\370\112"
	"\233\344\050\123\015\152\350\276\301\312\344\341\365\266\140\020"
	"\147\212\160\101\036\006\156\044\326\072\316\343\217\260\154\065"
	"\343\022\337\052\120\375\323\324\034\363\377\257\065\214\177\001"
	"\375\214\163\035\167\265\122\357\001\117\221\017\347\027\257\134"
	"\056\067\015\157\327\027\064\155\265\057\044\141\053\266\141\207"
	"\210\031\251\211\303\002\022\173\134\173\224\117\105\260\266\200"
	"\250\121\170\200\056\127\206\162\312\067\361\105\175\066\033\065"
	"\123\173\013\105\200\034\221\361\355\177\215\073\106\004\176\352"
	"\233\025\231\257\207\343\260\353\005\314\336\261\212\316\253\373"
	"\160\100\345\355\370\351\341\212\043\230\021\205\374\376\141\022"
	"\022\252\107\041\023\257\200\211\124\016\015\225\327\076\343\371"
	"\161\050\147\340\272\073\227\336\011\227\070\004\273\342\111\230"
	"\100\137\214\203\035\021\276\163\060\362\042\257\252\077\051\120"
	"\340\073\102\006\107\117\041\221\044\052\123\132\324\175\171\070"
	"\065\026\171\016\000\146\247\102\006\154\241\357\032\355\257\323"
	"\253\335\273\244\135\375\135\224\045\363\305\002\306\251\216\207"
	"\254\006\065\253\113\115\044\000\060\255\137\364\270\036\144\104"
	"\001\272\326\067\026\243\210\306\010\276\231\346\077\013\266\166"
	"\157\273\351\152\041\263\105\245\074\073\231\021\251\365\073\312"
	"\366\274\341\322\052\324\334\103\345\015\170\111\061\306\226\111"
	"\060\174\002\006\312\261\140\163\003\305\251\016\222\223\134\216"
	"\104\322\003\153\036\340\133\005\077\236\067\125\376\150\151\330"
	"\242\066\013\321\234\220\347\033\024\216\223\212\005\373\311\077"
	"\263\144\336\042\136\070\074\213\341\135\123\205\056\015\243\365"
	"\346\202\017\331\124\273\354\321\223\310\242\162\130\075\306\325"
	"\263\061\333\013\264\156\061\011\225\014\355\264\232\175\325\213"
	"\114\250\245\147\221\210\026\137\305\015\257\056\054\213\036\333"
	"\345\057\374\225\116\261\211\322\173\037\207\154\041\320\100\233"
	"\273\316\062\263\076\130\167\157\123\000\301\122\162\121\221\115"
	"\066\103\222\273\253\206\144\156\143\335\324\157\211\146\111\147"
	"\041\312\207\204\121\330\332\064\137\221\217\210\066\051\157\020"
	"\266\207\212\346\211\001\052\210\032\172\342\274\266\160\002\254"
	"\347\114\301\007\071\256\000\112\215\024\343\122\321\311\127\337"
	"\171\307\331\066\273\222\163\222\136\227\035\037\173\263\304\111"
	"\256\037\162\146\162\101\332\201\002\115\363\106\064\347\355\353"
	"\200\155\375\327\046\107\347\033\056\077\345\342\027\321\034\112"
	"\354\166\373\357\063\311\340\114\022\331\126\356\316\141\307\335"
	"\256\347\122\267\101\130\232\141\037\353\050\356\332\324\113\053"
	"\033\113\206\300\206\037\015\311\342\140\220\144\044\177\211\231"
	"\064\117\216\100\024\243\374\154\223\077\010\246\325\351\163\050"
	"\317\345\342\254\061\030\274\365\126\177\114\343\114\254\047\360"
	"\070\327\271\230\117\164\057\013\310\323\227\221\354\052\347\130"
	"\050\353\105\206\203\004\334\141\024\212\055\175\047\361\272\212"
	"\365\150\223\060\024\327\100\366\210\147\357\116\247\371\173\076"
	"\261\063\065\216\061\160\134\163\044\231\017\205\273\044\262\303"
	"\103\107\071\365\306\215\206\113\233\204\020\252\020\227\010\350"
	"\117\147\070\260\207\116\103\273\016\164\041\037\134\135\047\051"
	"\117\363\210\034\245\352\343\264\032\364\024\326\137\334\032\134"
	"\253\137\347\153\362\032\175\070\310\007\340\303\033\164\017\136"
	"\253\321\033\257\346\112\217\163\142\031\355\062\053\172\074\100"
	"\343\313\147\026\114\057\047\133\003\204\043\103\077\126\143\224"
	"\130\001\245\177\162\002\176\004\355\124\064\011\107\173\067\204"
	"\223\335\261\263\306\170\061\116\004\226\134\165\235\337\326\367"
	"\310\226\174\353\134\115\302\260\027\275\073\267\147\244\260\365"
	"\304\364\061\103\040\206\336\154\212\077\060\320\232\320\125\040"
	"\342\212\203\150\224\343\240\035\164\077\227\301\370\041\150\173"
	"\005\021\046\265\253\326\164\143\110\205\343\321\271\031\133\307"
	"\324\341\270\231\105\253\172\176\332\051\202\135\374\051\067\114"
	"\237\071\152\044\175\220\210\306\026\154\227\317\206\363\226\132"
	"\324\117\364\032\372\156\231\325\230\033\062\224\104\152\340\343"
	"\244\113\010\041\334\220\350\362\375\200\301\203\163\130\335\110"
	"\247\321\142\242\100\373\170\330\027\253\154\133\025\115\077\271"
	"\231\107\333\165\330\304\147\325\104\050\130\267\201\066\377\050"
	"\010\142\312\110\135\103\041\165\356\216\320\004\334\020\276\165"
	"\127\231\352\060\136\122\005\242\173\136\132\374\225\132\044\235"
	"\274\357\346\032\062\010\217\041\226\140\045\162\160\343\347\310"
	"\175\322\370\333\044\376\176\240\135\330\234\362\062\300\220\357"
	"\260\167\012\343\177\231\004\025\371\051\210\152\014\160\062\211"
	"\103\053\145\150\051\343\010\207\273\244\172\356\145\012\336\025"
	"\202\350\370\001\202\375\027\173\046\240\346\063\020\030\275\123"
	"\104\042\273\156\005\304\365\301\150\157\260\315\172\216\343\374"
	"\166\333\376\370\331\026\164\377\266\133\063\306\163\360\032\270"
	"\022\326\046\030\232\033\331\002\213\211\320\006\030\263\003\217"
	"\217\002\207\150\030\374\150\316\127"
#define      xecc_z	15
#define      xecc	((&data[2251]))
	"\213\260\361\242\242\205\124\062\122\361\156\023\111\326\361\106"
	"\154\203\235\206"
#define      lsto_z	1
#define      lsto	((&data[2269]))
	"\000"
#define      tst1_z	22
#define      tst1	((&data[2273]))
	"\121\031\364\120\342\377\073\346\351\360\151\002\243\322\006\015"
	"\230\314\154\311\245\356\004\366\213"/* End of data[] */;
#define      hide_z	4096
#define DEBUGEXEC	0	/* Define as 1 to debug execvp calls */
#define TRACEABLE	0	/* Define as 1 to enable ptrace the executable */

/* rtc.c */

#include <sys/stat.h>
#include <sys/types.h>

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

/* 'Alleged RC4' */

static unsigned char stte[256], indx, jndx, kndx;

/*
 * Reset arc4 stte. 
 */
void stte_0(void)
{
	indx = jndx = kndx = 0;
	do {
		stte[indx] = indx;
	} while (++indx);
}

/*
 * Set key. Can be used more than once. 
 */
void key(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		do {
			tmp = stte[indx];
			kndx += tmp;
			kndx += ptr[(int)indx % len];
			stte[indx] = stte[kndx];
			stte[kndx] = tmp;
		} while (++indx);
		ptr += 256;
		len -= 256;
	}
}

/*
 * Crypt data. 
 */
void arc4(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		indx++;
		tmp = stte[indx];
		jndx += tmp;
		stte[indx] = stte[jndx];
		stte[jndx] = tmp;
		tmp += stte[indx];
		*ptr ^= stte[tmp];
		ptr++;
		len--;
	}
}

/* End of ARC4 */

/*
 * Key with file invariants. 
 */
int key_with_file(char * file)
{
	struct stat statf[1];
	struct stat control[1];

	if (stat(file, statf) < 0)
		return -1;

	/* Turn on stable fields */
	memset(control, 0, sizeof(control));
	control->st_ino = statf->st_ino;
	control->st_dev = statf->st_dev;
	control->st_rdev = statf->st_rdev;
	control->st_uid = statf->st_uid;
	control->st_gid = statf->st_gid;
	control->st_size = statf->st_size;
	control->st_mtime = statf->st_mtime;
	control->st_ctime = statf->st_ctime;
	key(control, sizeof(control));
	return 0;
}

#if DEBUGEXEC
void debugexec(char * sh11, int argc, char ** argv)
{
	int i;
	fprintf(stderr, "shll=%s\n", sh11 ? sh11 : "<null>");
	fprintf(stderr, "argc=%d\n", argc);
	if (!argv) {
		fprintf(stderr, "argv=<null>\n");
	} else { 
		for (i = 0; i <= argc ; i++)
			fprintf(stderr, "argv[%d]=%.60s\n", i, argv[i] ? argv[i] : "<null>");
	}
}
#endif /* DEBUGEXEC */

void rmarg(char ** argv, char * arg)
{
	for (; argv && *argv && *argv != arg; argv++);
	for (; argv && *argv; argv++)
		*argv = argv[1];
}

int chkenv(int argc)
{
	char buff[512];
	unsigned long mask, m;
	int l, a, c;
	char * string;
	extern char ** environ;

	mask  = (unsigned long)&chkenv;
	mask ^= (unsigned long)getpid() * ~mask;
	sprintf(buff, "x%lx", mask);
	string = getenv(buff);
#if DEBUGEXEC
	fprintf(stderr, "getenv(%s)=%s\n", buff, string ? string : "<null>");
#endif
	l = strlen(buff);
	if (!string) {
		/* 1st */
		sprintf(&buff[l], "=%lu %d", mask, argc);
		putenv(strdup(buff));
		return 0;
	}
	c = sscanf(string, "%lu %d%c", &m, &a, buff);
	if (c == 2 && m == mask) {
		/* 3rd */
		rmarg(environ, &string[-l - 1]);
		return 1 + (argc - a);
	}
	return -1;
}

#if !defined(TRACEABLE)

#define _LINUX_SOURCE_COMPAT
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

#if !defined(PTRACE_ATTACH) && defined(PT_ATTACH)
#	define PTRACE_ATTACH	PT_ATTACH
#endif
void untraceable(char * argv0)
{
	char proc[80];
	int pid, mine;

	switch(pid = fork()) {
	case  0:
		pid = getppid();
		/* For problematic SunOS ptrace */
#if defined(__FreeBSD__)
		sprintf(proc, "/proc/%d/mem", (int)pid);
#else
		sprintf(proc, "/proc/%d/as",  (int)pid);
#endif
		close(0);
		mine = !open(proc, O_RDWR|O_EXCL);
		if (!mine && errno != EBUSY)
			mine = !ptrace(PTRACE_ATTACH, pid, 0, 0);
		if (mine) {
			kill(pid, SIGCONT);
		} else {
			perror(argv0);
			kill(pid, SIGKILL);
		}
		_exit(mine);
	case -1:
		break;
	default:
		if (pid == waitpid(pid, 0, 0))
			return;
	}
	perror(argv0);
	_exit(1);
}
#endif /* !defined(TRACEABLE) */

char * xsh(int argc, char ** argv)
{
	char * scrpt;
	int ret, i, j;
	char ** varg;

	stte_0();
	 key(pswd, pswd_z);
	arc4(msg1, msg1_z);
	arc4(date, date_z);
	if (date[0] && (atoll(date)<time(NULL)))
		return msg1;
	arc4(shll, shll_z);
	arc4(inlo, inlo_z);
	arc4(xecc, xecc_z);
	arc4(lsto, lsto_z);
	arc4(tst1, tst1_z);
	 key(tst1, tst1_z);
	arc4(chk1, chk1_z);
	if ((chk1_z != tst1_z) || memcmp(tst1, chk1, tst1_z))
		return tst1;
	ret = chkenv(argc);
	arc4(msg2, msg2_z);
	if (ret < 0)
		return msg2;
	varg = (char **)calloc(argc + 10, sizeof(char *));
	if (!varg)
		return 0;
	if (ret) {
		arc4(rlax, rlax_z);
		if (!rlax[0] && key_with_file(shll))
			return shll;
		arc4(opts, opts_z);
		arc4(text, text_z);
		arc4(tst2, tst2_z);
		 key(tst2, tst2_z);
		arc4(chk2, chk2_z);
		if ((chk2_z != tst2_z) || memcmp(tst2, chk2, tst2_z))
			return tst2;
		if (text_z < hide_z) {
			/* Prepend spaces til a hide_z script size. */
			scrpt = malloc(hide_z);
			if (!scrpt)
				return 0;
			memset(scrpt, (int) ' ', hide_z);
			memcpy(&scrpt[hide_z - text_z], text, text_z);
		} else {
			scrpt = text;	/* Script text */
		}
	} else {			/* Reexecute */
		if (*xecc) {
			scrpt = malloc(512);
			if (!scrpt)
				return 0;
			sprintf(scrpt, xecc, argv[0]);
		} else {
			scrpt = argv[0];
		}
	}
	j = 0;
	varg[j++] = argv[0];		/* My own name at execution */
	if (ret && *opts)
		varg[j++] = opts;	/* Options on 1st line of code */
	if (*inlo)
		varg[j++] = inlo;	/* Option introducing inline code */
	varg[j++] = scrpt;		/* The script itself */
	if (*lsto)
		varg[j++] = lsto;	/* Option meaning last option */
	i = (ret > 1) ? ret : 0;	/* Args numbering correction */
	while (i < argc)
		varg[j++] = argv[i++];	/* Main run-time arguments */
	varg[j] = 0;			/* NULL terminated array */
#if DEBUGEXEC
	debugexec(shll, j, varg);
#endif
	execvp(shll, varg);
	return shll;
}

int main(int argc, char ** argv)
{
#if DEBUGEXEC
	debugexec("main", argc, argv);
#endif
#if !defined(TRACEABLE)
	untraceable(argv[0]);
#endif
	argv[1] = xsh(argc, argv);
	fprintf(stderr, "%s%s%s: %s\n", argv[0],
		errno ? ": " : "",
		errno ? strerror(errno) : "",
		argv[1] ? argv[1] : "<null>"
	);
	return 1;
}
